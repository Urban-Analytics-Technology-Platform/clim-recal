---
title: "WIP MBC in R"
author: "Ruth C E Bowyer"
date: "`r format(Sys.Date())`"
output:
  github_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## 0. About

Testing Bias Correction methods from the MBC package in R

Loading data as created in 'DataProcessingMBC.RMD' 

```{r libraries dd}
rm(list=ls())

library(MBC)
library(terra)
library(sf)
library(exactextractr)
library(reshape2) #melt
library(data.table) #for fread

#Loaded package versions
x <- c("MBC", "terra", "sf", "exactextractr")
lapply(x,packageVersion)

#Path is "/<mount location>/vmfileshare/ClimateData
#dd <- "/Volumes/vmfileshare/ClimateData/"
dd <- "/mnt/vmfileshare/ClimateData/"
```
## 1. Load data
```{r}

fp <- paste0(dd, "Interim/NI_cropped_MBCdata/")
files <- list.files(paste0(dd, "Interim/NI_cropped_MBCdata"))

#HADs grid observational data
obs <- files[grepl("HAD", files)]

obs.dfs <- lapply(obs, function(x){
  fread(paste0(fp, x))
})

#Using 1980 - 2010 as calibration period
cpm.files <- files[grepl("CPM", files)]
cal <- cpm.files[grepl("1980|2000", cpm.files)]

cal.dfs <- lapply(cal, function(x){
  fread(paste0(fp, x))
})

gc()
```

```{r}
#R crashed when reading all of this in so for now just doing the projections for the next few decades 

proj1 <- cpm.files[grepl("2020|2020", cpm.files)]

proj.dfs <- lapply(proj1, function(x){
  fread(paste0(fp, x))
})


```


## Univariate quantile mapping

This package for univar mapping but soon to be multivar

Following the vignette here (first using the test data) https://cran.r-project.org/web/packages/MBC/MBC.pdf 

Do this seperately for each run

Below method is univariate quanitle mapping


Also need to understand better the vignette as if its really just using vectors that aren't spatially linked and applying them everywhere - then maybe the geography does matter ??? 
Next step multivariate mapping in same package 

```{r}
library(MBC)

# Univariate
  fit.qdm <- 
    QDM(o.c=Obs_oc, #vector of observed samples during the calibration period.
        m.c=Cal_oc, #vector of model outputs during the calibration period.
        m.p=Proj_oc, #vector of model outputs during the projected period.
        ratio=FALSE, #logical value indicating if samples are of a ratio quantity (e.g., precipitation) -- false as is temp
        trace=Inf) #numeric value indicating the threshold below which values of a ratio quantity (e.g., ratio=TRUE) should be considered exact zeros. -- need to read up on this 

  
mhat.c  <- fit.qdm$mhat.c
mhat.p   <- fit.qdm$mhat.p  
  
```




### Multivariate quantile mapping 

-- To do -- 

Need to ensure can reproject data as spatial appropariately 
Assess methods - split sample approach etc